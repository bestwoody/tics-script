#!/bin/bash

function cmd_ti_loop()
{
	local ti_file="${1}"
	local ti_args="${2}"
	local cmd_mod_names="${3}"
	local cmd_hosts="${4}"
	local cmd_indexes="${5}"
	local mods="${6}"
	shift 6

	if [ -z "${1+x}" ] || [ -z "${1}" ]; then
		echo "[cmd loop] usage: ti.sh [flags] ti_file_path loop cmd [args]"
		exit 1
	fi

	local cmd="${1}"
	local cmds_str=''
	for it in "${@}"; do
		if [ -z "${cmds_str}" ]; then
			local cmds_str="${it}"
		else
			local cmds_str="${cmds_str} ${it}"
		fi
	done

	source "`cd $(dirname ${BASH_SOURCE[0]}) && pwd`/_env.sh"
	auto_error_handle

	for (( r = 0; 0 == 0; r++ )); do
		if [ -z "`echo ${cmds_str} | grep ':'`" ]; then
			print_hhr
			echo ":: loop ${r}> ${cmds_str}"
			print_hr
			"${integrated}/ops/ti.sh" -h "${cmd_hosts}" -m "${cmd_mod_names}" \
				-i "${cmd_indexes}" -k "${ti_args}" "${ti_file}" "${@}"
		else
			"${integrated}/ops/ti.sh" -h "${cmd_hosts}" -m "${cmd_mod_names}" \
				-i "${cmd_indexes}" -k "${ti_args}" "${ti_file}" "${cmds_str}"
		fi
		sleep 0.1
	done
}

cmd_ti_loop "${@}"
